<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview - Score Processor</title>
    <style>
        body { font-family: sans-serif; background: #e9ecef; padding: 20px; color: #333; text-align: center; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .flash-message { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .error { color: red; margin-bottom: 15px; font-weight: bold; }
        .form-group { text-align: left; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"] { padding: 8px; box-sizing: border-box; }
        input[type="text"] { width: 100%; }
        button { background: #2ecc71; color: white; border: none; padding: 15px; font-size: 18px; cursor: pointer; width: 100%; border-radius: 4px; margin-bottom: 10px; }
        button.update { background: #f39c12; font-size: 16px; padding: 10px; margin-bottom: 10px; }
        button.cancel { background: #95a5a6; margin-top: 10px; margin-bottom: 30px; }
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; margin-bottom: 20px; }
        .preview-item { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .order-input-wrapper { margin-bottom: 10px; background: #e9ecef; padding: 5px; border-radius: 4px; }
        .order-input { width: 60px; font-size: 16px; font-weight: bold; text-align: center; }
        .preview-image { max-width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #ccc; margin: auto; cursor: zoom-in; }
        #image-modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); text-align: center; cursor: zoom-out; }
        #modal-img { max-width: 95%; max-height: 95vh; margin-top: 2.5vh; border: 2px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .flex-row { display: flex; gap: 10px; }
        .flex-row .form-group { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ç™»éŒ²</h1>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash-message">
              {% for message in messages %}
                <p style="margin:0;">{{ message }}</p>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        
        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}

        <form action="{{ url_for('save_score') }}" method="POST" onsubmit="hideSaveButton()">
            
            <div class="flex-row">
                <div class="form-group" style="flex: 0.3;">
                    <label for="year">å¹´åº¦:</label>
                    <input type="number" id="year" name="year" value="{{ year }}" required>
                </div>
                <div class="form-group">
                    <label for="event_name">æ¼”å¥ä¼šå:</label>
                    <input type="text" id="event_name" name="event_name" value="{{ event_name }}" list="event-list" placeholder="ä¾‹: å®šæœŸæ¼”å¥ä¼š" required autocomplete="off">
                    <datalist id="event-list">
                        {% for name in event_names %}
                            <option value="{{ name }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
            </div>

            <div class="form-group">
                <label for="piece">æ¥½æ›²å (Piece): <span style="font-weight:normal; font-size:0.8em; color:#666;">â€»è‡ªå‹•æ¨æ¸¬</span></label>
                <input type="text" id="piece" name="piece" value="{{ piece_guess }}" list="piece-list" required autocomplete="off">
                <datalist id="piece-list">
                    {% for name in piece_names %}
                        <option value="{{ name }}"></option>
                    {% endfor %}
                </datalist>
            </div>
            <div class="form-group">
                <label for="instrument">æ¥½å™¨å (Instrument):</label>
                <input type="text" id="instrument" name="instrument" value="{{ inst_guess }}" required>
            </div>
            
            {% for filename in previews %}
                <input type="hidden" name="previews" value="{{ filename }}">
            {% endfor %}
            
            <button type="submit" id="btn-save">ã“ã®å†…å®¹ã¨é †ç•ªã§DBã«ç™»éŒ²ãƒ»ä¿å­˜</button>
            <p id="save-loading" style="display:none; color:#2ecc71; font-weight:bold;">ä¿å­˜ä¸­...</p>
        </form>

        <form action="{{ url_for('index') }}" method="GET">
            <button type="submit" class="cancel" id="btn-cancel">ã™ã¹ã¦ç ´æ£„ã—ã¦ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
        </form>

        <hr>
        <h3>å‡¦ç†çµæœ (å…¨ {{ previews|length }} ãƒšãƒ¼ã‚¸)</h3>
        
        <form action="{{ url_for('update_order') }}" method="POST" onsubmit="showLoadingUpdate()">
            <input type="hidden" name="year" id="hidden_year" value="{{ year }}">
            <input type="hidden" name="event_name" id="hidden_event" value="{{ event_name }}">
            <input type="hidden" name="piece" id="hidden_piece" value="{{ piece_guess }}">
            <input type="hidden" name="instrument" id="hidden_inst" value="{{ inst_guess }}">
            
            <button type="submit" class="update btn-update">ğŸ”„ æ•°å­—ã‚’æ›¸ãæ›ãˆã¦é †ç•ªã‚’æ›´æ–°</button>

            <div class="preview-grid">
                {% for filename in previews %}
                    <div class="preview-item">
                        <div class="order-input-wrapper">
                            <label>è¡¨ç¤ºé †: <input type="number" name="orders[]" class="order-input" value="{{ loop.index }}" min="1"></label>
                            <input type="hidden" name="filenames[]" value="{{ filename }}">
                        </div>
                        <img src="{{ url_for('static', filename='temp/previews/' ~ filename) }}" class="preview-image" onclick="openModal(this.src)">
                    </div>
                {% endfor %}
            </div>
            
            <button type="submit" class="update btn-update">ğŸ”„ æ•°å­—ã‚’æ›¸ãæ›ãˆã¦é †ç•ªã‚’æ›´æ–°</button>
        </form>
    </div>

    <div id="image-modal" onclick="closeModal()">
        <img id="modal-img" src="">
    </div>

    <script>
        // å…¨ã¦ã®å…¥åŠ›å†…å®¹ã‚’ã€é †ç•ªæ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ã«åŒæœŸã•ã›ã‚‹
        document.getElementById('year').addEventListener('input', function(e) { document.getElementById('hidden_year').value = e.target.value; });
        document.getElementById('event_name').addEventListener('input', function(e) { document.getElementById('hidden_event').value = e.target.value; });
        document.getElementById('piece').addEventListener('input', function(e) { document.getElementById('hidden_piece').value = e.target.value; });
        document.getElementById('instrument').addEventListener('input', function(e) { document.getElementById('hidden_inst').value = e.target.value; });

        function openModal(imageSrc) { document.getElementById('modal-img').src = imageSrc; document.getElementById('image-modal').style.display = 'block'; }
        function closeModal() { document.getElementById('image-modal').style.display = 'none'; }
        
        function hideSaveButton() {
            document.getElementById('btn-save').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            var updateBtns = document.getElementsByClassName('btn-update');
            for(var i=0; i<updateBtns.length; i++) updateBtns[i].style.display = 'none';
            document.getElementById('save-loading').style.display = 'block';
        }
        
        function showLoadingUpdate() {
            document.getElementById('btn-save').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            var updateBtns = document.getElementsByClassName('btn-update');
            for(var i=0; i<updateBtns.length; i++) updateBtns[i].style.display = 'none';
        }
    </script>
</body>
</html>