<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ç™»éŒ² - Score Processor</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #f0f2f5;
        }

        /* ==============================
           å·¦ãƒšã‚¤ãƒ³ï¼šæƒ…å ±å…¥åŠ›ã‚¨ãƒªã‚¢
        ============================== */
        .left-pane {
            width: 400px;
            background: #ffffff;
            padding: 20px 30px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
            overflow-y: auto;
            border-right: 1px solid #e1e4e8;
        }

        .left-pane h2 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.9em;
        }

        .form-group input[type="text"], 
        .form-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccd1d9;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: #fcfcfc;
            transition: border-color 0.2s;
        }
        
        .form-group input[type="text"]:focus, 
        .form-group input[type="number"]:focus {
            border-color: #3498db;
            outline: none;
        }

        /* å‹•çš„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ */
        .profile-option {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .profile-option:hover {
            background: #f1f2f6;
        }

        .profile-option.selected {
            background: #ebf5fb;
            border-color: #3498db;
        }

        .profile-option input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .profile-details {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-left: 24px;
            margin-top: 4px;
        }

        #newPieceFields {
            background: #fff;
            padding: 15px;
            border: 1px dashed #3498db;
            border-radius: 6px;
            margin-bottom: 18px;
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }

        .btn-submit:hover {
            background: #2980b9;
        }

        /* ==============================
           å³ãƒšã‚¤ãƒ³ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ç·¨é›†ã‚¨ãƒªã‚¢
        ============================== */
        .right-pane {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
        }

        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .header-area h2 {
            margin: 0;
            color: #2c3e50;
        }

        .btn-update {
            background: #2ecc71;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-update:hover {
            background: #27ae60;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
        }

        .grid-item {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #e1e4e8;
        }

        .page-badge {
            background: #34495e;
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .grid-item img {
            max-width: 100%;
            height: 300px;
            object-fit: contain;
            border: 1px solid #f0f0f0;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 15px;
            transition: opacity 0.3s;
        }

        .order-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
            justify-content: center;
        }

        .order-input {
            width: 60px;
            text-align: center;
            padding: 6px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-weight: bold;
        }

        .rotate-controls {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .rotate-controls button {
            flex: 1;
            padding: 8px 0;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
            transition: background 0.2s;
        }

        .rotate-controls button:hover {
            background: #bdc3c7;
        }
    </style>
</head>
<body>

    <div class="left-pane">
        <a href="{{ url_for('index') }}" style="display: inline-block; margin-bottom: 15px; color: #7f8c8d; text-decoration: none; font-weight: bold;">â—€ ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        
        <h2>ğŸ“ æ¥½è­œã®ç™»éŒ²</h2>
        
        <form action="{{ url_for('save_score') }}" method="POST" id="saveForm">
            
            <div class="form-group">
                <label>æ›²å</label>
                <input type="text" id="pieceInput" name="piece" value="{{ piece_guess }}" list="piece_list" required autocomplete="off" placeholder="ä¾‹: å®å³¶">
                <datalist id="piece_list">
                    {% for p in piece_names %}
                        <option value="{{ p }}">
                    {% endfor %}
                </datalist>
            </div>

            <div class="form-group">
                <label>ä¿å­˜å…ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</label>
                <div id="profileSelection">
                    </div>
            </div>

            <div id="newPieceFields" style="display: none;">
                <div class="form-group">
                    <label>ä½œæ›²è€…</label>
                    <input type="text" name="new_composer" list="comp_list" placeholder="ä½œæ›²è€…å">
                    <datalist id="comp_list">
                        {% for comp in composers %}
                            <option value="{{ comp }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>ç·¨æ›²è€…</label>
                    <input type="text" name="new_arranger" list="arr_list" placeholder="ç·¨æ›²è€…å">
                    <datalist id="arr_list">
                        {% for arr in arrangers %}
                            <option value="{{ arr }}">
                        {% endfor %}
                    </datalist>
                </div>
            </div>

            <div class="form-group">
                <label>æ¥½å™¨ãƒ‘ãƒ¼ãƒˆ</label>
                <input type="text" name="instrument" value="{{ inst_guess }}" required placeholder="ä¾‹: Flute 1">
            </div>

            <div class="form-group">
                <label>è¡Œäº‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰å</label>
                <input type="text" name="event_name" list="event_list" required placeholder="ä¾‹: ç¬¬1å›å®šæœŸæ¼”å¥ä¼š">
                <datalist id="event_list">
                    {% for ev in event_names %}
                        <option value="{{ ev }}">
                    {% endfor %}
                </datalist>
            </div>

            <div class="form-group">
                <label>å¹´åº¦ (è¥¿æš¦)</label>
                <input type="number" name="year" value="{{ current_year }}" required>
            </div>

            <div id="hidden-previews-container">
                {% for fname in previews %}
                    <input type="hidden" name="previews" value="{{ fname }}">
                {% endfor %}
            </div>

            <button type="submit" class="btn-submit">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜</button>
        </form>
    </div>

    <div class="right-pane">
        <form action="{{ url_for('update_order') }}" method="POST" id="orderForm">
            <input type="hidden" id="hiddenPiece" name="piece" value="{{ piece_guess }}">
            <input type="hidden" id="hiddenInst" name="instrument" value="{{ inst_guess }}">
            
            <div class="header-area">
                <h2>ğŸ–¼ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨èª¿æ•´ ({{ previews|length }} ãƒšãƒ¼ã‚¸)</h2>
                <button type="submit" class="btn-update">âœ“ è¡¨ç¤ºé †ã‚’æ›´æ–°ã™ã‚‹</button>
            </div>

            <div class="grid-container">
                {% for fname in previews %}
                <div class="grid-item">
                    <div class="page-badge">Page {{ loop.index }}</div>
                    
                    <img id="img-{{ fname }}" src="{{ url_for('static', filename='temp/previews/' ~ fname) }}" alt="Preview">
                    
                    <div class="order-control">
                        <label style="font-size: 0.9em; color: #555; font-weight: bold;">é †ç•ª:</label>
                        <input type="number" name="orders[]" value="{{ loop.index }}" class="order-input" min="1" max="{{ previews|length }}">
                        <input type="hidden" name="filenames[]" value="{{ fname }}">
                    </div>

                    <div class="rotate-controls">
                        <button type="button" onclick="rotateImage('{{ fname }}', 'left')" title="å·¦ã«90åº¦å›è»¢">â†º 90Â°</button>
                        <button type="button" onclick="rotateImage('{{ fname }}', '180')" title="ä¸Šä¸‹åè»¢">â‡… 180Â°</button>
                        <button type="button" onclick="rotateImage('{{ fname }}', 'right')" title="å³ã«90åº¦å›è»¢">â†» 90Â°</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </form>
    </div>

    <script>
        // --- 1. å·¦ãƒšã‚¤ãƒ³ã®å‹•çš„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ ---
        const pieceInput = document.getElementById('pieceInput');
        const profileSelection = document.getElementById('profileSelection');
        const newPieceFields = document.getElementById('newPieceFields');

        // å³ãƒšã‚¤ãƒ³ã®é †åºæ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ç”¨éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é€£å‹•ã•ã›ã‚‹
        pieceInput.addEventListener('input', function() {
            document.getElementById('hiddenPiece').value = this.value;
            fetchProfiles();
        });
        document.querySelector('input[name="instrument"]').addEventListener('input', function() {
            document.getElementById('hiddenInst').value = this.value;
        });

        function fetchProfiles() {
            const piece = pieceInput.value.trim();
            if (!piece) {
                renderProfiles([]);
                return;
            }
            
            // APIã‚’å©ã„ã¦åŒåã®æ›²ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            fetch('/api/get_profiles?piece=' + encodeURIComponent(piece))
                .then(res => res.json())
                .then(data => renderProfiles(data))
                .catch(err => console.error('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', err));
        }

        function renderProfiles(profiles) {
            let html = '';
            
            // å¸¸ã«ã€Œæ–°è¦ç™»éŒ²ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”¨æ„ã™ã‚‹
            html += `
                <label class="profile-option selected" id="lbl_mode_new" onclick="selectProfile('new')">
                    <input type="radio" id="mode_new" name="save_mode" value="new" checked>
                    <strong>âœ¨ æ–°è¦æ¥½æ›²ã¨ã—ã¦ç™»éŒ²</strong>
                </label>
            `;

            // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Œã°ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
            profiles.forEach((p, index) => {
                const comp = p.composer ? p.composer : 'æœªè¨­å®š';
                const arr = p.arranger ? p.arranger : 'æœªè¨­å®š';
                
                html += `
                    <label class="profile-option" id="lbl_mode_ex_${index}" onclick="selectProfile('existing_${index}')">
                        <input type="radio" id="mode_ex_${index}" name="save_mode" value="existing_${index}">
                        <strong>ğŸ“‚ æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ </strong>
                        <div class="profile-details">ä½œæ›²: ${comp} / ç·¨æ›²: ${arr}</div>
                        <input type="hidden" name="ex_id_${index}" value="${p.id}">
                    </label>
                `;
            });

            profileSelection.innerHTML = html;
            selectProfile('new'); // åˆæœŸçŠ¶æ…‹ã¯ã€Œæ–°è¦ã€ã‚’é¸æŠ
        }

        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã«åˆã‚ã›ã¦è¦‹ãŸç›®ã¨å…¥åŠ›æ¬„ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        function selectProfile(mode) {
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            const radio = document.getElementById(mode === 'new' ? 'mode_new' : 'mode_ex_' + mode.split('_')[1]);
            if (radio) radio.checked = true;

            // ã‚¹ã‚¿ã‚¤ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.profile-option').forEach(el => el.classList.remove('selected'));
            const labelId = mode === 'new' ? 'lbl_mode_new' : 'lbl_mode_ex_' + mode.split('_')[1];
            const labelEl = document.getElementById(labelId);
            if (labelEl) labelEl.classList.add('selected');

            // ã€Œæ–°è¦ã€ã®ã¨ãã ã‘ä½œæ›²è€…ãƒ»ç·¨æ›²è€…å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
            newPieceFields.style.display = (mode === 'new') ? 'block' : 'none';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸€åº¦ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã™ã‚‹ (æ¨æ¸¬ã•ã‚ŒãŸæ›²åãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã®ãŸã‚)
        document.addEventListener('DOMContentLoaded', fetchProfiles);

        // --- 2. å³ãƒšã‚¤ãƒ³ã®ç”»åƒæ‰‹å‹•å›è»¢å‡¦ç† ---
        function rotateImage(filename, direction) {
            const imgElement = document.getElementById('img-' + filename);
            imgElement.style.opacity = '0.4'; // å‡¦ç†ä¸­ã¯åŠé€æ˜

            const formData = new FormData();
            formData.append('filename', filename);
            formData.append('direction', direction);

            fetch('{{ url_for("rotate_image") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ãŸã‚ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ä¸
                    const currentSrc = imgElement.src.split('?')[0];
                    imgElement.src = currentSrc + '?t=' + new Date().getTime();
                } else {
                    alert('å›è»¢ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            })
            .finally(() => {
                imgElement.onload = function() {
                    imgElement.style.opacity = '1.0';
                };
                setTimeout(() => { imgElement.style.opacity = '1.0'; }, 1000);
            });
        }
    </script>
</body>
</html>