<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview - Score Processor</title>
    <style>
        body { font-family: sans-serif; background: #e9ecef; padding: 20px; color: #333; text-align: center; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: left; }
        .flash-message { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .error { color: red; margin-bottom: 15px; font-weight: bold; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"] { padding: 8px; box-sizing: border-box; width: 100%; }
        button { background: #3498db; color: white; border: none; padding: 15px; font-size: 18px; cursor: pointer; width: 100%; border-radius: 4px; margin-bottom: 10px; font-weight: bold; }
        button.update { background: #f39c12; font-size: 16px; padding: 10px; margin-bottom: 10px; }
        button.cancel { background: #95a5a6; margin-top: 10px; margin-bottom: 30px; }
        
        .dest-section { border: 2px solid #bdc3c7; border-radius: 8px; padding: 15px; background: #fafafa; margin-bottom: 20px; }
        .radio-group { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: #fff; cursor: pointer; display: block; transition: border 0.2s; }
        .radio-group:hover { border-color: #3498db; }
        .radio-group input[type="radio"] { transform: scale(1.3); margin-right: 10px; cursor: pointer; }
        .meta-info { display: block; margin-left: 30px; color: #666; font-size: 0.9em; margin-top: 5px; }
        
        .new-inputs-box { margin-top: 15px; margin-left: 30px; padding: 15px; border-left: 4px solid #e67e22; background: #fff; }
        .flex-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .flex-row .form-group { flex: 1; margin-bottom: 0; }
        
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; margin-bottom: 20px; }
        .preview-item { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .order-input-wrapper { margin-bottom: 10px; background: #e9ecef; padding: 5px; border-radius: 4px; }
        .order-input { width: 60px; font-size: 16px; font-weight: bold; text-align: center; }
        .preview-image { max-width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #ccc; margin: auto; cursor: zoom-in; }
        #image-modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); text-align: center; cursor: zoom-out; }
        #modal-img { max-width: 95%; max-height: 95vh; margin-top: 2.5vh; border: 2px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ç™»éŒ²</h1>

        {% if error %}<div class="error">{{ error }}</div>{% endif %}

        <form action="{{ url_for('save_score') }}" method="POST" onsubmit="hideSaveButton()">
            
            <div class="flex-row">
                <div class="form-group" style="flex: 0.3;">
                    <label>å¹´åº¦:</label>
                    <input type="number" name="year" value="{{ year|default(current_year) }}" required>
                </div>
                <div class="form-group">
                    <label>æ¼”å¥ä¼šå (è¿½åŠ ã•ã‚Œã‚‹è¡Œäº‹):</label>
                    <input type="text" name="event_name" list="event-list" placeholder="ä¾‹: å®šæœŸæ¼”å¥ä¼š" required autocomplete="off">
                    <datalist id="event-list">
                        {% for name in event_names %} <option value="{{ name }}"></option> {% endfor %}
                    </datalist>
                </div>
            </div>

            <div class="form-group">
                <label for="piece">æ¥½æ›²å (Piece): <span style="font-weight:normal; font-size:0.8em; color:#666;">â€»å…¥åŠ›ã™ã‚‹ã¨ä¸‹ã®ç™»éŒ²å…ˆãŒè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™</span></label>
                <input type="text" id="piece" name="piece" value="{{ piece_guess }}" list="piece-list" required autocomplete="off" oninput="fetchProfiles()">
                <datalist id="piece-list">
                    {% for name in piece_names %} <option value="{{ name }}"></option> {% endfor %}
                </datalist>
            </div>

            <div class="form-group">
                <label for="instrument">æ¥½å™¨å / ãƒ‘ãƒ¼ãƒˆ (Instrument):</label>
                <input type="text" id="instrument" name="instrument" value="{{ inst_guess }}" required>
            </div>
            
            <div class="dest-section">
                <h3 style="margin-top: 0; color: #2c3e50;">ğŸ“Œ ç™»éŒ²å…ˆã®é¸æŠ</h3>
                
                <div id="existing-profiles-container"></div>
                
                <label class="radio-group" style="display: block;">
                    <input type="radio" name="save_mode" value="new" id="radio-new" checked required>
                    <span style="font-weight: bold; color: #e67e22;">æ–°ã—ãåˆ¥ã®æ¥½è­œï¼ˆã¾ãŸã¯åˆ¥ã‚¢ãƒ¬ãƒ³ã‚¸ï¼‰ã¨ã—ã¦ç™»éŒ²ã™ã‚‹</span>
                    
                    <div class="new-inputs-box" id="new-inputs-box">
                        <div class="flex-row">
                            <div class="form-group">
                                <label>ä½œæ›²è€… (ä»»æ„):</label>
                                <input type="text" name="new_composer" list="comp-list" autocomplete="off">
                                <datalist id="comp-list">
                                    {% for name in composers %} <option value="{{ name }}"></option> {% endfor %}
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label>ç·¨æ›²è€… (ä»»æ„):</label>
                                <input type="text" name="new_arranger" list="arr-list" autocomplete="off">
                                <datalist id="arr-list">
                                    {% for name in arrangers %} <option value="{{ name }}"></option> {% endfor %}
                                </datalist>
                            </div>
                        </div>
                    </div>
                </label>
            </div>
            
            {% for filename in previews %}
                <input type="hidden" name="previews" value="{{ filename }}">
            {% endfor %}
            
            <button type="submit" id="btn-save" style="background: #2ecc71;">ã“ã®å†…å®¹ã§ç¢ºå®šã—ã¦ä¿å­˜</button>
            <p id="save-loading" style="display:none; color:#2ecc71; font-weight:bold; text-align:center;">ä¿å­˜å‡¦ç†ä¸­...</p>
        </form>

        <form action="{{ url_for('index') }}" method="GET">
            <button type="submit" class="cancel" id="btn-cancel">ã™ã¹ã¦ç ´æ£„ã—ã¦ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
        </form>

        <hr>
        <h3 style="text-align: center;">å‡¦ç†çµæœ (å…¨ {{ previews|length }} ãƒšãƒ¼ã‚¸)</h3>
        
        <form action="{{ url_for('update_order') }}" method="POST">
            <input type="hidden" name="piece" id="hidden_piece" value="{{ piece_guess }}">
            <input type="hidden" name="instrument" id="hidden_inst" value="{{ inst_guess }}">
            
            <button type="submit" class="update btn-update">ğŸ”„ æ•°å­—ã‚’æ›¸ãæ›ãˆã¦é †ç•ªã‚’æ›´æ–°</button>

            <div class="preview-grid">
                {% for filename in previews %}
                    <div class="preview-item">
                        <div class="order-input-wrapper">
                            <label>è¡¨ç¤ºé †: <input type="number" name="orders[]" class="order-input" value="{{ loop.index }}" min="1"></label>
                            <input type="hidden" name="filenames[]" value="{{ filename }}">
                        </div>
                        <img src="{{ url_for('static', filename='temp/previews/' ~ filename) }}" class="preview-image" onclick="openModal(this.src)">
                    </div>
                {% endfor %}
            </div>
            <button type="submit" class="update btn-update">ğŸ”„ æ•°å­—ã‚’æ›¸ãæ›ãˆã¦é †ç•ªã‚’æ›´æ–°</button>
        </form>
    </div>

    <div id="image-modal" onclick="closeModal()">
        <img id="modal-img" src="">
    </div>

    <script>
        async function fetchProfiles() {
            const piece = document.getElementById('piece').value.trim();
            const container = document.getElementById('existing-profiles-container');
            const radioNew = document.getElementById('radio-new');
            
            if (!piece) {
                container.innerHTML = '';
                radioNew.checked = true;
                return;
            }

            try {
                const res = await fetch('/api/get_profiles?piece=' + encodeURIComponent(piece));
                const profiles = await res.json();
                
                if (profiles.length > 0) {
                    let html = '<p style="font-weight:bold; color:#d35400; margin-bottom:10px;">ğŸ’¡ æ—¢å­˜ã®æ¥½è­œãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚</p>';
                    profiles.forEach((p, idx) => {
                        let ev_str = p.events.map(e => `${e.year}${e.event_name}`).join(', ');
                        html += `
                        <label class="radio-group">
                            <input type="radio" name="save_mode" value="existing_${idx}" required>
                            <span style="font-weight: bold; color: #2980b9;">ã“ã®æ¥½è­œã«ãƒ‘ãƒ¼ãƒˆ/ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ ãƒ»è¡Œäº‹ã‚’ç´ä»˜ã‘ã‚‹</span>
                            <span class="meta-info">
                                âœï¸ ä½œ: ${p.composer || '-'} / ç·¨: ${p.arranger || '-'}<br>
                                ğŸ“… æ—¢å­˜ã®è¡Œäº‹: ${ev_str}
                            </span>
                            <input type="hidden" name="ex_id_${idx}" value="${p.id}">
                        </label>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color:#7f8c8d; margin-bottom:15px;">ã“ã®æ¥½æ›²ã¯åˆã‚ã¦ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</p>';
                    radioNew.checked = true;
                }
            } catch (e) {
                console.error(e);
            }
        }

        window.onload = function() { fetchProfiles(); };

        document.getElementById('piece').addEventListener('input', function(e) { document.getElementById('hidden_piece').value = e.target.value; });
        document.getElementById('instrument').addEventListener('input', function(e) { document.getElementById('hidden_inst').value = e.target.value; });

        function openModal(imageSrc) { document.getElementById('modal-img').src = imageSrc; document.getElementById('image-modal').style.display = 'block'; }
        function closeModal() { document.getElementById('image-modal').style.display = 'none'; }
        
        function hideSaveButton() {
            document.getElementById('btn-save').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            var updateBtns = document.getElementsByClassName('btn-update');
            for(var i=0; i<updateBtns.length; i++) updateBtns[i].style.display = 'none';
            document.getElementById('save-loading').style.display = 'block';
        }
    </script>
</body>
</html>