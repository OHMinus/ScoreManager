<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スキャン作業 - Score Processor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="page-scan">
    <div class="container">
        <h1>スキャン作業</h1>
        
        <div class="status-box">
            現在読み込み済みのページ数: {{ scanned_files|length }} ページ
        </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash-message">
              {% for message in messages %}
                <p style="margin:0;">{{ message }}</p>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <form method="POST" id="scanForm">
            <input type="hidden" name="device_name" value="{{ device_name|default('') }}">
            
            {% for filename in scanned_files %}
                <input type="hidden" name="scanned_files[]" value="{{ filename }}">
            {% endfor %}
            
            <div id="loading-overlay">
                <div class="loader"></div>
                <p>スキャナー稼働・画像処理中...<br><small>※完了してページが更新されるまで触らずにお待ちください</small></p>
            </div>

            <button type="submit" formaction="{{ url_for('scan_execute') }}" class="btn-scan" id="btn-scan">
                🖨️ スキャナーを動かしてページを読み込む
            </button>
            
            <p style="color: #666; font-size: 14px; margin-bottom: 25px;">
                ※楽譜をセットして上のボタンを押してください。必要なページ数だけ繰り返します。
            </p>

            {% if scanned_files %}
            <button type="submit" formaction="{{ url_for('scan_to_preview') }}" class="btn-finish">
                ✅ 全てスキャン完了（プレビュー・登録画面へ進む）
            </button>
            {% else %}
            <button type="button" class="btn-finish" style="background: #bdc3c7; cursor: not-allowed;">
                ✅ 全てスキャン完了（プレビュー・登録画面へ進む）
            </button>
            {% endif %}
        </form>

        <form action="{{ url_for('index') }}" method="GET">
            <button type="submit" class="btn-cancel">中止してトップへ戻る</button>
        </form>

        {% if scanned_files %}
        <div class="thumb-grid">
            {% for filename in scanned_files %}
            <div class="thumb-item">
                <img src="{{ url_for('static', filename='temp/previews/' ~ filename) }}">
                <p>Page {{ loop.index }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

    </div>

    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
</body>
</html>